<!-- app/templates/chat.html -->
<!DOCTYPE html>
<html lang="zh-Hant">
    <head>
        <meta charset="UTF-8" />
        <title>AI 課程推薦系統</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/anandzhang/markdown-css/css/markdown.css" />
        <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
        <style>
            body, html {
                margin: 0;
                padding: 0;
                height: 100vh;
                overflow: hidden;
                background-color: #f8f9fa;
            }
            .chat-layout {
                display: flex;
                height: 100vh;
                width: 100%;
                overflow: hidden;
            }
            .sidebar {
                width: 300px;
                background-color: #ffffff;
                border-right: 1px solid #e0e0e0;
                height: 100%;
                overflow-y: auto;
                padding: 20px;
                box-shadow: 0 0 10px rgba(0,0,0,0.05);
            }
            .chat-section {
                flex: 1;
                display: flex;
                flex-direction: column;
                height: 100%;
                overflow: hidden;
            }
            .chat-box {
                flex: 1;
                overflow-y: auto;
                padding: 20px;
                background-color: #fff;
            }
            .input-area {
                padding: 15px 20px;
                background-color: #fff;
                border-top: 1px solid #e0e0e0;
                display: flex;
                align-items: center;
            }
            .chat-entry {
                margin-bottom: 20px;
            }
            .user-reply {
                background-color: #0d6efd;
                color: white;
                border-radius: 18px;
                padding: 12px 18px;
                max-width: 75%;
                word-wrap: break-word;
                margin-left: auto;
                box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            }
            .bot-reply {
                background-color: #f5f5f5;
                border-radius: 18px;
                padding: 12px 18px;
                max-width: 75%;
                word-wrap: break-word;
                margin-right: auto;
                box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            }
            .markdown-body-light {
                background-color: transparent;
                color: inherit;
                font-size: 0.95rem;
                line-height: 1.5;
            }
            .form-check-label {
                margin-right: 10px;
            }
            .nav-top {
                padding: 15px;
                background-color: #fff;
                border-bottom: 1px solid #e0e0e0;
                text-align: center;
                font-weight: bold;
                font-size: 1.2rem;
            }
            textarea.form-control {
                border-radius: 20px;
                padding: 10px 15px;
                resize: none;
                border: 1px solid #ccc;
                flex: 1;
            }
            .send-btn {
                background-color: #0d6efd;
                border: none;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                margin-left: 10px;
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.2s;
            }
            .send-btn:hover {
                background-color: #0b5ed7;
            }
            .send-btn:disabled {
                background-color: #6c757d;
                cursor: not-allowed;
            }
            .dot-flashing {
                position: relative;
                width: 10px;
                height: 10px;
                border-radius: 5px;
                background-color: #9880ff;
                color: #9880ff;
                animation: dot-flashing 1s infinite linear alternate;
                animation-delay: 0.5s;
                margin: 0 5px;
            }
            .dot-flashing::before, .dot-flashing::after {
                content: '';
                display: inline-block;
                position: absolute;
                top: 0;
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                // 滾動到底
                const chatBox = document.querySelector(".chat-box");
                const scrollBtn = document.getElementById("scroll-to-bottom");
                const aiThinking = document.getElementById("ai-thinking");
                
                scrollToBottom();

                // 監聽滾動事件來顯示或隱藏滾動按鈕
                chatBox.addEventListener("scroll", function() {
                    const isNearBottom = chatBox.scrollHeight - chatBox.scrollTop - chatBox.clientHeight < 100;
                    scrollBtn.style.display = isNearBottom ? "none" : "flex";
                });

                // 點擊滾動按鈕
                scrollBtn.addEventListener("click", scrollToBottom);

                function scrollToBottom() {
                    chatBox.scrollTop = chatBox.scrollHeight;
                }

                // 初始化 markdown-it
                const md = window.markdownit({ 
                    breaks: true,
                    linkify: true,
                    typographer: true 
                });

                // 渲染現有的 markdown
                function renderMarkdown() {
                    document.querySelectorAll("script[type='application/json']").forEach((script) => {
                        const index = script.id.replace("md-", "");
                        const container = document.getElementById("rendered-" + index);
                        try {
                            let raw = JSON.parse(script.textContent.trim());
                            if (typeof raw === "string") raw = raw.trim();
                            container.innerHTML = md.render(raw);
                        } catch (e) {
                            container.innerHTML = `<pre style="color: red;">❗ 渲染失敗：${e.message}</pre>`;
                        }
                    });
                }

                // 初始渲染
                renderMarkdown();

                // 自動儲存時間選擇
                const checkboxes = document.querySelectorAll('input[type="checkbox"][name="timeslot"]');
                const submitBtn = document.getElementById("submit-btn");
                const userInput = document.getElementById("user-input");
                const chatContainer = document.getElementById("chat-container");
                const hiddenInput = document.getElementById("hidden-input");
                const chatForm = document.getElementById("chat-form");

                // 自動調整文本域高度
                userInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    const newHeight = Math.min(this.scrollHeight, 150);
                    this.style.height = newHeight + 'px';
                });

                checkboxes.forEach((cb) => {
                    cb.addEventListener("change", function () {
                        const selected = Array.from(checkboxes)
                            .filter((c) => c.checked)
                            .map((c) => c.value);

                        fetch("/save_schedule", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ slots: selected }),
                        })
                            .then((res) => res.json())
                            .then((data) => {
                                console.log("✅ 排程已更新");
                            })
                            .catch(() => {
                                alert("❌ 儲存失敗，請稍後再試");
                            });
                    });
                });

                // 聊天提交處理
                submitBtn.addEventListener("click", function(e) {
                    const message = userInput.value.trim();
                    if (!message) return;
                    
                    sendMessage(message);
                });

                // 按 Enter 鍵提交
                userInput.addEventListener("keydown", function (e) {
                    if (e.key === "Enter" && !e.shiftKey) {
                        e.preventDefault();
                        const message = userInput.value.trim();
                        if (message) {
                            sendMessage(message);
                        }
                    }
                });

                function sendMessage(message) {
                    // 禁用按鈕
                    submitBtn.disabled = true;
                    
                    // 新增使用者訊息到聊天框
                    const userMessageHtml = `
                        <div class="chat-entry">
                            <div class="d-flex justify-content-end">
                                <div class="user-reply">${escapeHtml(message)}</div>
                            </div>
                        </div>
                    `;
                    chatContainer.insertAdjacentHTML("beforeend", userMessageHtml);
                    
                    // 顯示AI思考動畫
                    aiThinking.style.display = "block";
                    
                    // 滾動到底部
                    scrollToBottom();
                    
                    // 清空輸入框並重設高度
                    userInput.value = "";
                    userInput.style.height = 'auto';

                    // 獲取已選擇的時段
                    const selected = Array.from(checkboxes)
                        .filter((c) => c.checked)
                        .map((c) => c.value);

                    // 使用 AJAX 發送請求
                    fetch("/chat", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            user_input: message,
                            slots: selected,
                        }),
                    })
                        .then((res) => res.json())
                        .then((data) => {
                            // 隱藏AI思考動畫
                            aiThinking.style.display = "none";

                            // 創建機器人回覆元素
                            const botIndex = document.querySelectorAll(".chat-entry").length + 1;
                            const botReplyHtml = `
                                <div class="chat-entry">
                                    <div class="d-flex justify-content-start">
                                        <div class="bot-reply markdown-body-light" id="rendered-${botIndex}"></div>
                                    </div>
                                    <script type="application/json" id="md-${botIndex}">${JSON.stringify(data.answer)}<\/script>
                                </div>
                            `;

                            // 添加到聊天容器
                            chatContainer.insertAdjacentHTML("beforeend", botReplyHtml);

                            // 重新渲染 markdown
                            renderMarkdown();

                            // 滾動到底部
                            scrollToBottom();
                        })
                        .catch((err) => {
                            console.error("聊天錯誤:", err);
                            aiThinking.style.display = "none";
                            
                            // 顯示錯誤訊息
                            const errorHtml = `
                                <div class="chat-entry">
                                    <div class="d-flex justify-content-start">
                                        <div class="bot-reply markdown-body-light" style="color: #dc3545;">
                                            ❌ 發送失敗，請稍後再試
                                        </div>
                                    </div>
                                </div>
                            `;
                            chatContainer.insertAdjacentHTML("beforeend", errorHtml);

                            // 如果需要，可以嘗試傳統表單提交
                            // hiddenInput.value = message;
                            // chatForm.submit();
                        })
                        .finally(() => {
                            // 重新啟用按鈕
                            submitBtn.disabled = false;
                        });
                }

                // HTML 轉義函數
                function escapeHtml(unsafe) {
                    return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
                }
            });
        </script>
    </body>
</html>         // 滾動到底
                const chatBox = document.querySelector(".chat-box");
                if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;

                // 初始化 markdown-it
                const md = window.markdownit({ breaks: true });

                // 渲染現有的 markdown
                function renderMarkdown() {
                    document.querySelectorAll("script[type='application/json']").forEach((script) => {
                        const index = script.id.replace("md-", "");
                        const container = document.getElementById("rendered-" + index);
                        try {
                            let raw = JSON.parse(script.textContent.trim());
                            if (typeof raw === "string") raw = raw.trim();
                            container.innerHTML = md.render(raw);
                        } catch (e) {
                            container.innerHTML = `<pre style="color: red;">❗ 渲染失敗：${e.message}</pre>`;
                        }
                    });
                }

                // 初始渲染
                renderMarkdown();

                // 自動儲存時間選擇
                const checkboxes = document.querySelectorAll('input[type="checkbox"][name="timeslot"]');
                const loading = document.getElementById("loading");
                const submitBtn = document.getElementById("submit-btn");
                const userInput = document.getElementById("user-input");
                const chatContainer = document.getElementById("chat-container");

                checkboxes.forEach((cb) => {
                    cb.addEventListener("change", function () {
                        const selected = Array.from(checkboxes)
                            .filter((c) => c.checked)
                            .map((c) => c.value);

                        fetch("/save_schedule", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ slots: selected }),
                        })
                            .then((res) => res.json())
                            .then((data) => {
                                console.log("✅ 儲存回應:", data);
                            })
                            .catch(() => {
                                alert("❌ 儲存失敗，請稍後再試");
                            });
                    });
                });

                // 獲取表單元素
                const chatForm = document.getElementById("chat-form");

                // 聊天提交處理 - 攔截表單提交事件，改用 AJAX
                chatForm.addEventListener("submit", function (e) {
                    e.preventDefault(); // 阻止傳統表單提交

                    const message = userInput.value.trim();
                    if (!message) return;

                    // 禁用按鈕和顯示載入中
                    submitBtn.disabled = true;
                    loading.style.display = "block";

                    // 新增使用者訊息到聊天框
                    const userMessageHtml = `
        <div class="chat-entry">
          <div class="d-flex justify-content-end">
            <div class="user-reply text-white bg-primary p-2 rounded mb-1" style="max-width: 75%;">
              ${escapeHtml(message)}
            </div>
          </div>
        </div>
      `;
                    chatContainer.insertAdjacentHTML("beforeend", userMessageHtml);

                    // 獲取已選擇的時段
                    const selected = Array.from(checkboxes)
                        .filter((c) => c.checked)
                        .map((c) => c.value);

                    // 確認瀏覽器支援 fetch API
                    if (window.fetch) {
                        // 使用 AJAX 發送請求
                        fetch("/chat", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                user_input: message,
                                slots: selected,
                            }),
                        })
                            .then((res) => res.json())
                            .then((data) => {
                                // 清空輸入框
                                userInput.value = "";

                                // 創建機器人回覆元素
                                const botIndex = document.querySelectorAll(".chat-entry").length + 1;
                                const botReplyHtml = `
          <div class="chat-entry">
            <div class="d-flex justify-content-start">
              <div class="bot-reply markdown-body-light" id="rendered-${botIndex}"></div>
            </div>
            <script type="application/json" id="md-${botIndex}">${JSON.stringify(data.answer)}<\/script>
          </div>
        `;

                                // 添加到聊天容器
                                chatContainer.insertAdjacentHTML("beforeend", botReplyHtml);

                                // 重新渲染 markdown
                                renderMarkdown();

                                // 滾動到底部
                                chatBox.scrollTop = chatBox.scrollHeight;
                            })
                            .catch((err) => {
                                console.error("聊天錯誤:", err);
                                alert("❌ 發送失敗，請稍後再試");

                                // 如果 AJAX 失敗，回退到傳統表單提交
                                chatForm.submit();
                            })
                            .finally(() => {
                                // 重新啟用按鈕並隱藏載入中
                                submitBtn.disabled = false;
                                loading.style.display = "none";
                            });
                    } else {
                        // 瀏覽器不支援 fetch API，使用傳統表單提交
                        chatForm.submit();
                    }
                });

                // 按 Enter 鍵提交
                userInput.addEventListener("keydown", function (e) {
                    if (e.key === "Enter" && !e.shiftKey) {
                        e.preventDefault();
                        submitBtn.click();
                    }
                });

                // HTML 轉義函數
                function escapeHtml(unsafe) {
                    return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
                }
            });
        </script>
    </body>
</html>
