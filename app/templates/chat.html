<!-- app/templates/chat.html -->
<!DOCTYPE html>
<html lang="zh-Hant">
    <head>
        <meta charset="UTF-8" />
        <title>AI 課程推薦系統</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/anandzhang/markdown-css/css/markdown.css" />
        <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
        <style>
            body {
                background-color: #f8f9fa;
            }
            .container {
                margin-top: 30px;
            }
            .chat-box {
                max-height: 600px;
                overflow-y: auto;
                background: #fff;
                padding: 15px;
                border-radius: 8px;
                border: 1px solid #dee2e6;
            }
            .chat-entry {
                margin-bottom: 15px;
            }
            .chat-user {
                font-weight: bold;
                color: #0d6efd;
            }
            .chat-bot {
                font-weight: bold;
                color: #198754;
            }
            .bot-reply {
                padding: 1rem;
                border-radius: 0.5rem;
                background-color: #f5f5f5;
            }
            .markdown-body-light {
                background-color: transparent;
                color: inherit;
                font-size: 0.95rem;
                line-height: 1.4;
            }
            .timeslot-box {
                background: #fff;
                padding: 15px;
                border-radius: 8px;
                border: 1px solid #dee2e6;
                max-height: 600px;
                overflow-y: auto;
            }
            .form-check-label {
                margin-right: 10px;
            }
            .user-reply {
                background-color: #0d6efd;
                color: white;
                border-radius: 1rem;
                padding: 0.75rem 1rem;
                word-wrap: break-word;
            }

            .bot-reply {
                background-color: #f5f5f5;
                border-radius: 1rem;
                padding: 0.75rem 1rem;
                max-width: 75%;
                word-wrap: break-word;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="row">
                <!-- 左：時間選擇 -->
                <div class="col-md-4">
                    <div class="timeslot-box">
                        <h5>選擇課堂時間</h5>
                        <div class="row">
                            {% set weekdays = ['日','一','二','三','四','五','六','日'] %} {% set periods = ['0','1','2','3','4','5','6','7','8','9','10','A','B','C','D'] %} {% for i in range(1,8) %}
                            <div class="col-12 mb-2">
                                <strong>星期{{ weekdays[i] }}</strong><br />
                                {% for p in periods %}
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" name="timeslot" value="{{ i }}_{{ p }}" id="{{ i }}_{{ p }}" {% if i ~ '_' ~ p in selected_slots %}checked{% endif
                                    %}>
                                    <label class="form-check-label" for="{{ i }}_{{ p }}">{{ p }}</label>
                                </div>
                                {% endfor %}
                            </div>
                            {% endfor %}
                        </div>
                        <div id="loading" style="display: none" class="text-center mt-3">⏳ 載入中，請稍候...</div>
                    </div>
                </div>

                <!-- 右：聊天區 -->
                <div class="col-md-8">
                    <div class="chat-box mb-3" id="chat-container">
                        {% for chat in chat_history %}
                        <div class="chat-entry">
                            {% if chat.user %}
                            <!-- 使用者輸入（右邊對齊） -->
                            <div class="d-flex justify-content-end">
                                <div class="user-reply text-white bg-primary p-2 rounded mb-1" style="max-width: 75%">{{ chat.user }}</div>
                            </div>
                            {% endif %}

                            <!-- AI 回覆（左邊對齊） -->
                            <div class="d-flex justify-content-start">
                                <div class="bot-reply markdown-body-light" id="rendered-{{ loop.index }}"></div>
                            </div>

                            <script type="application/json" id="md-{{ loop.index }}">
                                {{ chat.bot | tojson | safe }}
                            </script>
                        </div>
                        {% endfor %}
                    </div>
                    <div>
                        <div class="mb-3">
                            <textarea class="form-control" id="user-input" rows="2" placeholder="輸入你的問題..."></textarea>
                        </div>
                        <button type="button" class="btn btn-primary" id="submit-btn">送出</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                // 滾動到底
                const chatBox = document.querySelector(".chat-box");
                if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;

                // 初始化 markdown-it
                const md = window.markdownit({ breaks: true });

                // 渲染現有的 markdown
                function renderMarkdown() {
                    document.querySelectorAll("script[type='application/json']").forEach((script) => {
                        const index = script.id.replace("md-", "");
                        const container = document.getElementById("rendered-" + index);
                        try {
                            let raw = JSON.parse(script.textContent.trim());
                            if (typeof raw === "string") raw = raw.trim();
                            container.innerHTML = md.render(raw);
                        } catch (e) {
                            container.innerHTML = `<pre style="color: red;">❗ 渲染失敗：${e.message}</pre>`;
                        }
                    });
                }

                // 初始渲染
                renderMarkdown();

                // 自動儲存時間選擇
                const checkboxes = document.querySelectorAll('input[type="checkbox"][name="timeslot"]');
                const loading = document.getElementById("loading");
                const submitBtn = document.getElementById("submit-btn");
                const userInput = document.getElementById("user-input");
                const chatContainer = document.getElementById("chat-container");

                checkboxes.forEach((cb) => {
                    cb.addEventListener("change", function () {
                        const selected = Array.from(checkboxes)
                            .filter((c) => c.checked)
                            .map((c) => c.value);

                        fetch("/save_schedule", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ slots: selected }),
                        })
                            .then((res) => res.json())
                            .then((data) => {
                                console.log("✅ 儲存回應:", data);
                            })
                            .catch(() => {
                                alert("❌ 儲存失敗，請稍後再試");
                            });
                    });
                });

                // 聊天提交處理
                submitBtn.addEventListener("click", function () {
                    const message = userInput.value.trim();
                    if (!message) return;

                    // 禁用按鈕和顯示載入中
                    submitBtn.disabled = true;
                    loading.style.display = "block";

                    // 新增使用者訊息到聊天框
                    const userMessageHtml = `
        <div class="chat-entry">
          <div class="d-flex justify-content-end">
            <div class="user-reply text-white bg-primary p-2 rounded mb-1" style="max-width: 75%;">
              ${escapeHtml(message)}
            </div>
          </div>
        </div>
      `;
                    chatContainer.insertAdjacentHTML("beforeend", userMessageHtml);

                    // 獲取已選擇的時段
                    const selected = Array.from(checkboxes)
                        .filter((c) => c.checked)
                        .map((c) => c.value);

                    // 發送 AJAX 請求
                    fetch("/chat", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            user_input: message,
                            slots: selected,
                        }),
                    })
                        .then((res) => res.json())
                        .then((data) => {
                            // 清空輸入框
                            userInput.value = "";

                            // 創建機器人回覆元素
                            const botIndex = document.querySelectorAll(".chat-entry").length + 1;
                            const botReplyHtml = `
          <div class="chat-entry">
            <div class="d-flex justify-content-start">
              <div class="bot-reply markdown-body-light" id="rendered-${botIndex}"></div>
            </div>
            <script type="application/json" id="md-${botIndex}">${JSON.stringify(data.answer)}<\/script>
          </div>
        `;

                            // 添加到聊天容器
                            chatContainer.insertAdjacentHTML("beforeend", botReplyHtml);

                            // 重新渲染 markdown
                            renderMarkdown();

                            // 滾動到底部
                            chatBox.scrollTop = chatBox.scrollHeight;
                        })
                        .catch((err) => {
                            console.error("聊天錯誤:", err);
                            alert("❌ 發送失敗，請稍後再試");
                        })
                        .finally(() => {
                            // 重新啟用按鈕並隱藏載入中
                            submitBtn.disabled = false;
                            loading.style.display = "none";
                        });
                });

                // 按 Enter 鍵提交
                userInput.addEventListener("keydown", function (e) {
                    if (e.key === "Enter" && !e.shiftKey) {
                        e.preventDefault();
                        submitBtn.click();
                    }
                });

                // HTML 轉義函數
                function escapeHtml(unsafe) {
                    return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
                }
            });
        </script>
    </body>
</html>
